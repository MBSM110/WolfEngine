<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_gametime.hpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/*
    Project: Wolf Engine. Copyright Â© 2014-2022 Pooya Eimandar
    https://github.com/WolfEngine/WolfEngine
*/

#pragma once

#include &lt;wolf.hpp&gt;
#include &lt;chrono&gt;
#include &lt;cmath&gt;

namespace wolf::system {
constexpr auto MAX_DELTA_TIME_IN_SECS = 60000.0; // 60 minutes
constexpr auto TARGET_ELAPSED_SECS = 1.0 / 60.0;

class w_gametime {
public:
  // default constructor
<span style = "background-color:#fdd">  W_API w_gametime() noexcept = default;</span>

  // destructor
<span style = "background-color:#fdd">  W_API virtual ~w_gametime() noexcept = default;</span>

  // move constructor
<span style = "background-color:#fdd">  W_API w_gametime(w_gametime &amp;&amp;p_src) noexcept = default;</span>

  // move assignment operator.
<span style = "background-color:#fdd">  W_API w_gametime &amp;operator=(w_gametime &amp;&amp;p_src) noexcept = default;</span>

  W_API void reset() noexcept;

  [[nodiscard]] W_API constexpr double get_elapsed_secs() const noexcept;

  [[nodiscard]] W_API constexpr double get_total_secs() const noexcept;

  [[nodiscard]] W_API uint32_t get_frames_count() const noexcept;

  [[nodiscard]] W_API uint32_t get_fps() const noexcept;

  [[nodiscard]] W_API bool get_is_fixed_time_step() const noexcept;

  W_API void set_fixed_time_step(bool p_value) noexcept;

  W_API void set_target_elapsed_secs(double p_value) noexcept;

<span style = "background-color:#fdd">  template &lt;typename F&gt; [[noreturn]] W_API void tick(F &amp;&amp;p_tick_function) {</span>
    using namespace std::chrono;

    // Query the current time.
<span style = "background-color:#fdd">    const auto current_time = steady_clock::now();
    auto delta =</span>
        duration&lt;double, std::milli&gt;(current_time - this-&gt;_last_time).count() /
        1000.000;

<span style = "background-color:#fdd">    this-&gt;_last_time = current_time;
    this-&gt;_secs_counter += delta;</span>

    // clamp excessively large time deltas (e.g. after paused in the debugger).
<span style = "background-color:#fdd">    if (delta &gt; MAX_DELTA_TIME_IN_SECS) {
      delta = MAX_DELTA_TIME_IN_SECS;</span>
    }

<span style = "background-color:#fdd">    const auto last_frames_count = this-&gt;_frames_count;
    if (this-&gt;_fixed_time_step) {</span>
      /*
         If the app is running very close to the target elapsed time (within
         1/4 of a millisecond (400 microseconds)) just clamp the clock to
         exactly match the target value. This prevents tiny and irrelevant
         errors from accumulating over time. Without this clamping, a game that
         requested a 60 fps fixed update, running with vsync enabled on a 59.94
         NTSC display, would eventually accumulate enough tiny errors that it
         would drop a frame. It is better to just round small deviations down to
         zero to leave things running smoothly.
      */
<span style = "background-color:#fdd">      constexpr auto quarter_of_one_milli_in_sec = 0.0004;
      if (std::abs(delta - this-&gt;_target_elapsed_secs) &lt;</span>
          quarter_of_one_milli_in_sec) {
<span style = "background-color:#fdd">        delta = this-&gt;_target_elapsed_secs;</span>
      }

<span style = "background-color:#fdd">      this-&gt;_left_over_ticks += delta;
      this-&gt;_elapsed_secs = this-&gt;_target_elapsed_secs;</span>

#ifdef __clang__
#pragma unroll
#endif
<span style = "background-color:#fdd">      while (this-&gt;_left_over_ticks &gt;= this-&gt;_target_elapsed_secs) {</span>

<span style = "background-color:#fdd">        this-&gt;_total_secs += this-&gt;_target_elapsed_secs;
        this-&gt;_left_over_ticks -= this-&gt;_target_elapsed_secs;</span>

<span style = "background-color:#fdd">        this-&gt;_frames_count++;
        p_tick_function();
      }
    } else {</span>
      // variable timestep update logic.
<span style = "background-color:#fdd">      this-&gt;_left_over_ticks = 0.0;
      this-&gt;_total_secs += delta;
      this-&gt;_elapsed_secs = delta;
      this-&gt;_frames_count++;
      p_tick_function();</span>
    }

    // track the current framerate.
<span style = "background-color:#fdd">    this-&gt;_frames_this_sec += (this-&gt;_frames_count - last_frames_count);</span>

<span style = "background-color:#fdd">    auto one_sec = 1.0;
    if (this-&gt;_secs_counter &gt;= one_sec) {
      this-&gt;_fps = this-&gt;_frames_this_sec;
      this-&gt;_frames_this_sec = 0;
      this-&gt;_secs_counter = std::modf(this-&gt;_secs_counter, &amp;one_sec);</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  [[noreturn]] W_API void tick() {
    tick([] {});
  }</span>

private:
  // copy constructor.
  w_gametime(const w_gametime &amp;) = delete;
  // copy assignment operator.
  w_gametime &amp;operator=(const w_gametime &amp;) = delete;

  // configuring fixed timestep mode.
<span style = "background-color:#fdd">  bool _fixed_time_step = false;</span>

<span style = "background-color:#fdd">  double _target_elapsed_secs = {TARGET_ELAPSED_SECS};
  double _elapsed_secs = 0.0;
  double _total_secs = 0.0;
  double _left_over_ticks = 0.0;
  double _secs_counter = 0.0;
  uint32_t _fps = 0;
  uint32_t _frames_count = 0;
  uint32_t _frames_this_sec = 0;</span>

  std::chrono::steady_clock::time_point _last_time = {
<span style = "background-color:#fdd">      std::chrono::steady_clock::now()};</span>
}
#ifdef __clang__
W_ALIGNMENT_64
#endif
    ;
} // namespace wolf::system</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>