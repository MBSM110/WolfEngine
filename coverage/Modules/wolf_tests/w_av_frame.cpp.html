<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_av_frame.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#ifdef WOLF_MEDIA_FFMPEG

#include "w_av_frame.hpp"

#include &lt;DISABLE_ANALYSIS_BEGIN&gt;
extern "C" {
#include &lt;libavutil/imgutils.h&gt;
#include &lt;libswscale/swscale.h&gt;
}
#include &lt;DISABLE_ANALYSIS_END&gt;

#define STB_IMAGE_IMPLEMENTATION
#include &lt;stb_image.h&gt;

#define STB_IMAGE_WRITE_IMPLEMENTATION
#include &lt;stb_image_write.h&gt;

using w_av_frame = wolf::media::ffmpeg::w_av_frame;
using w_av_config = wolf::media::ffmpeg::w_av_config;

<span style = "background-color:#fdd">int w_av_config::get_required_buffer_size() noexcept {
  return av_image_get_buffer_size(this-&gt;format, this-&gt;width, this-&gt;height,</span>
                                  this-&gt;alignment);
<span style = "background-color:#fdd">}</span>

w_av_frame::w_av_frame(_In_ const w_av_config &amp;p_config) noexcept
<span style = "background-color:#fdd">    : _config(p_config), _av_frame(nullptr), _moved_data(nullptr) {}</span>

<span style = "background-color:#fdd">w_av_frame::w_av_frame(w_av_frame &amp;&amp;p_other) noexcept {
  _move(std::move(p_other));
}</span>

<span style = "background-color:#fdd">w_av_frame &amp;w_av_frame::operator=(w_av_frame &amp;&amp;p_other) noexcept {
  _move(std::move(p_other));
  return *this;
}</span>

<span style = "background-color:#fdd">void w_av_frame::_move(w_av_frame &amp;&amp;p_other) noexcept {
  if (this == &amp;p_other)
    return;</span>

<span style = "background-color:#fdd">  _release();</span>

<span style = "background-color:#fdd">  this-&gt;_config = std::move(p_other._config);
  this-&gt;_av_frame = std::exchange(p_other._av_frame, nullptr);
  this-&gt;_moved_data = std::exchange(p_other._moved_data, nullptr);
}</span>

<span style = "background-color:#fdd">w_av_frame::~w_av_frame() noexcept { _release(); }</span>

<span style = "background-color:#fdd">void w_av_frame::_release() noexcept {
  if (this-&gt;_moved_data != nullptr) {
    free(this-&gt;_moved_data);
    this-&gt;_moved_data = nullptr;</span>
  }
<span style = "background-color:#fdd">  if (this-&gt;_av_frame != nullptr) {
    av_frame_free(&amp;this-&gt;_av_frame);
    this-&gt;_av_frame = nullptr;</span>
  }
<span style = "background-color:#fdd">}</span>

<span style = "background-color:#fdd">boost::leaf::result&lt;int&gt; w_av_frame::init() noexcept { return set(nullptr); }</span>

<span style = "background-color:#fdd">boost::leaf::result&lt;int&gt; w_av_frame::set(_Inout_ uint8_t **p_data) noexcept {</span>

<span style = "background-color:#fdd">  const auto _width = this-&gt;_config.width;
  const auto _height = this-&gt;_config.height;
  const auto _alignment = this-&gt;_config.alignment;</span>

  // check for width and height
<span style = "background-color:#fdd">  if (_width &lt;= 0 || _height &lt;= 0) {
    return W_ERR(std::errc::invalid_argument,</span>
                 "width or height of w_av_frame is zero");
  }

<span style = "background-color:#fdd">  if (this-&gt;_av_frame == nullptr) {
    this-&gt;_av_frame = av_frame_alloc();</span>
    // check for the memory
<span style = "background-color:#fdd">    const auto _av_frame_nn = gsl::narrow_cast&lt;AVFrame *&gt;(this-&gt;_av_frame);</span>

<span style = "background-color:#fdd">    _av_frame_nn-&gt;format = gsl::narrow_cast&lt;int&gt;(this-&gt;_config.format);
    _av_frame_nn-&gt;width = this-&gt;_config.width;
    _av_frame_nn-&gt;height = this-&gt;_config.height;</span>
  }

<span style = "background-color:#fdd">  const auto _av_frame_nn = gsl::narrow_cast&lt;AVFrame *&gt;(this-&gt;_av_frame);</span>

  // move the owenership of data to buffer
  uint8_t *_data_ptr;
<span style = "background-color:#fdd">  if (p_data == nullptr) {
    const auto _buffer_size = this-&gt;_config.get_required_buffer_size();
    _data_ptr = this-&gt;_moved_data = gsl::owner&lt;uint8_t *&gt;(malloc(_buffer_size));
  } else {
    _data_ptr = std::exchange(*p_data, nullptr);
    this-&gt;_moved_data = nullptr;</span>
  }
<span style = "background-color:#fdd">  const auto _size = av_image_fill_arrays(</span>
      _av_frame_nn-&gt;data, _av_frame_nn-&gt;linesize,
      gsl::narrow_cast&lt;const uint8_t *&gt;(_data_ptr), this-&gt;_config.format,
      _av_frame_nn-&gt;width, _av_frame_nn-&gt;height, _alignment);

<span style = "background-color:#fdd">  return W_SUCCESS;
}</span>
  
<span style = "background-color:#fdd">std::tuple&lt;uint8_t **, int *&gt; w_av_frame::get() const noexcept {
  const auto _av_frame_nn = gsl::narrow_cast&lt;AVFrame *&gt;(this-&gt;_av_frame);
  return std::make_tuple(_av_frame_nn-&gt;data, _av_frame_nn-&gt;linesize);
}</span>

<span style = "background-color:#fdd">w_av_config w_av_frame::get_config() const noexcept { return this-&gt;_config; }</span>

boost::leaf::result&lt;w_av_frame&gt;
<span style = "background-color:#fdd">w_av_frame::convert(_In_ const w_av_config &amp;p_dst_config) {</span>

  // create buffer and dst frame
<span style = "background-color:#fdd">  w_av_frame _dst_frame(p_dst_config);
  _dst_frame.set(nullptr);</span>

<span style = "background-color:#fdd">  const auto _dst_avframe_nn =</span>
      gsl::narrow_cast&lt;AVFrame *&gt;(_dst_frame._av_frame);

<span style = "background-color:#fdd">  auto *_context = sws_getContext(</span>
      this-&gt;_config.width, this-&gt;_config.height, this-&gt;_config.format,
      _dst_frame._config.width, _dst_frame._config.height,
      _dst_frame._config.format, SWS_BICUBIC, nullptr, nullptr, nullptr);

  // check the memory
<span style = "background-color:#fdd">  const auto _context_nn = gsl::not_null&lt;SwsContext *&gt;(_context);</span>

<span style = "background-color:#fdd">  const auto _height =</span>
      sws_scale(_context_nn,
                gsl::narrow_cast&lt;const uint8_t *const *&gt;(this-&gt;_av_frame-&gt;data),
                gsl::narrow_cast&lt;const int *&gt;(this-&gt;_av_frame-&gt;linesize), 0,
                this-&gt;_config.height,
                gsl::narrow_cast&lt;uint8_t *const *&gt;(_dst_avframe_nn-&gt;data),
                gsl::narrow_cast&lt;const int *&gt;(_dst_avframe_nn-&gt;linesize));

  // free context
<span style = "background-color:#fdd">  sws_freeContext(_context_nn);</span>

<span style = "background-color:#fdd">  if (_height &lt; 0) {
    return W_ERR(std::errc::invalid_argument, "w_av_frame sws_scale failed");</span>
  }

<span style = "background-color:#fdd">  return _dst_frame;
}</span>

#ifdef WOLF_MEDIA_STB

boost::leaf::result&lt;w_av_frame&gt;
w_av_frame::load_from_img_file(_In_ const std::filesystem::path &amp;p_path,
<span style = "background-color:#dfd">                               _In_ AVPixelFormat p_pixel_fmt) {</span>

  // width, height, comp
<span style = "background-color:#dfd">  int _width = 0;
  int _height = 0;
  int _comp = 0;</span>

<span style = "background-color:#dfd">  const auto _path = p_path.string();
  if (std::filesystem::exists(p_path) == false) {
    return W_ERR(std::errc::invalid_argument,</span>
                 " path not exist for av_frame" + _path);
  }

<span style = "background-color:#fdd">  auto *_raw_img_data = stbi_load(_path.c_str(), &amp;_width, &amp;_height, &amp;_comp, 0);</span>

<span style = "background-color:#fdd">  if (_raw_img_data == nullptr) {
    return W_ERR(std::errc::invalid_argument,</span>
                 "could not load image file " + _path);
  }

<span style = "background-color:#fdd">  const auto _img_size = _width * _height * _comp;</span>

<span style = "background-color:#fdd">  w_av_config _src_config = {p_pixel_fmt, _width, _height};</span>
  // create an av_frame from image raw data
<span style = "background-color:#fdd">  w_av_frame _src_frame(_src_config);
  _src_frame.set(&amp;_raw_img_data);</span>

<span style = "background-color:#fdd">  return _src_frame;</span>
<span style = "background-color:#dfd">}</span>

boost::leaf::result&lt;int&gt;
w_av_frame::save_to_img_file(_In_ const std::filesystem::path &amp;p_path,
<span style = "background-color:#fdd">                             int p_quality) {
  if (this-&gt;_av_frame == nullptr) {
    return W_ERR(std::errc::invalid_argument,</span>
                 "missing avframe");
  }

<span style = "background-color:#fdd">  const auto _path = p_path.string();
  auto _ext = p_path.extension().string();
  std::transform(_ext.cbegin(), _ext.cend(), _ext.begin(), tolower);</span>

<span style = "background-color:#fdd">  const auto _comp = this-&gt;_av_frame-&gt;linesize[0] / this-&gt;_av_frame-&gt;width;
  if (_ext == ".bmp") {</span>

<span style = "background-color:#fdd">    return stbi_write_bmp(_path.c_str(), this-&gt;_config.width,</span>
                          this-&gt;_config.height, _comp,
                          this-&gt;_av_frame-&gt;data[0]);
<span style = "background-color:#fdd">  } else if (_ext == ".png") {</span>

<span style = "background-color:#fdd">    return stbi_write_png(_path.c_str(), this-&gt;_config.width,</span>
                          this-&gt;_config.height, _comp, this-&gt;_av_frame-&gt;data[0],
                          this-&gt;_av_frame-&gt;linesize[0]);
<span style = "background-color:#fdd">  } else if (_ext == ".jpg" || _ext == ".jpeg") {</span>

<span style = "background-color:#fdd">    return stbi_write_jpg(_path.c_str(), this-&gt;_config.width,</span>
                          this-&gt;_config.height, _comp, this-&gt;_av_frame-&gt;data[0],
                          p_quality);
<span style = "background-color:#fdd">  } else {
    return W_ERR(std::errc::invalid_argument,</span>
                 "image format not supported for " + _path);
  }
<span style = "background-color:#fdd">}</span>

#endif

#endif // WOLF_MEDIA_FFMPEG</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>