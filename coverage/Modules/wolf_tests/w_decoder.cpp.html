<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_decoder.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
ï»¿#ifdef WOLF_MEDIA_FFMPEG

#include "w_decoder.hpp"

using w_decoder = wolf::media::ffmpeg::w_decoder;

boost::leaf::result&lt;int&gt;
w_decoder::start(_In_ const w_av_packet &amp;p_packet,
<span style = "background-color:#fdd">                 _Inout_ w_av_frame &amp;p_frame) noexcept {</span>

<span style = "background-color:#fdd">  auto _dst_packet = av_packet_alloc();
  if (_dst_packet == nullptr) {
    return W_ERR(std::errc::not_enough_memory,</span>
                 "could not allocate packet for decoding");
  }

<span style = "background-color:#fdd">  auto _ret = W_OK();</span>
#ifdef __clang__
#pragma unroll
#endif
  for (;;) {
<span style = "background-color:#fdd">    const auto _bytes = av_parser_parse2(</span>
        this-&gt;ctx.parser, this-&gt;ctx.codec_ctx, &amp;_dst_packet-&gt;data,
        &amp;_dst_packet-&gt;size, p_packet._packet-&gt;data, p_packet._packet-&gt;size,
        AV_NOPTS_VALUE, AV_NOPTS_VALUE, 0);

<span style = "background-color:#fdd">    if (_bytes &lt; 0) {
      return W_ERR(std::errc::not_enough_memory,</span>
                   "could not parse packet for decoding");
    }

<span style = "background-color:#fdd">    p_packet._packet-&gt;data += _bytes;
    p_packet._packet-&gt;size -= _bytes;</span>

<span style = "background-color:#fdd">    if (_dst_packet-&gt;size == 0) {
      break;</span>
    }

<span style = "background-color:#fdd">    if (_dst_packet-&gt;size &gt; 0) {
      _ret = _get_packet_from_frame(_dst_packet, p_frame);
      if (_ret.has_error()) {
        break;</span>
      }
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  av_packet_free(&amp;_dst_packet);</span>

<span style = "background-color:#fdd">  return _ret;
}</span>

boost::leaf::result&lt;int&gt;
w_decoder::_get_packet_from_frame(_In_ AVPacket *p_packet,
<span style = "background-color:#fdd">                                  _Inout_ w_av_frame &amp;p_frame) {</span>
  // start decoding
<span style = "background-color:#fdd">  auto _ret = avcodec_send_packet(this-&gt;ctx.codec_ctx, p_packet);
  if (_ret &lt; 0) {
    return W_ERR(std::errc::operation_canceled,</span>
                 "could not parse packet for decoding because of " +
                     w_ffmpeg_ctx::get_av_error_str(_ret));
  }

  for (;;) {
<span style = "background-color:#fdd">    _ret = avcodec_receive_frame(this-&gt;ctx.codec_ctx, p_frame._av_frame);
    if (_ret == 0 || _ret == AVERROR(EAGAIN) || _ret == AVERROR_EOF) {
      break;</span>
    }

<span style = "background-color:#fdd">    if (_ret &lt; 0) {
      return W_ERR(std::errc::operation_canceled,</span>
                   "error happened during the encoding because " +
                       w_ffmpeg_ctx::get_av_error_str(_ret));
<span style = "background-color:#fdd">      break;</span>
    }
<span style = "background-color:#fdd">  }
  return _ret;
}</span>

#endif // WOLF_MEDIA_FFMPEG</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>