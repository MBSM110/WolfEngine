<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_rist.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#ifdef WOLF_STREAM_RIST

#include "w_rist.hpp"
#include &lt;Objbase.h&gt;

using w_rist = wolf::stream::rist::w_rist;
using w_rist_data_block = wolf::stream::rist::w_rist_data_block;

#pragma region callbacks

static int s_on_log_callback(_In_ void *p_arg, _In_ rist_log_level p_log_level,
<span style = "background-color:#dfd">                             _In_z_ const char *p_msg) {
  const gsl::not_null&lt;w_rist *&gt; _rist_nn(gsl::narrow_cast&lt;w_rist *&gt;(p_arg));
  if (_rist_nn-&gt;on_log_callback) {</span>
<span style = "background-color:#fdd">    _rist_nn-&gt;on_log_callback(p_log_level, p_msg);</span>
  }
<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

static int s_on_auth_handler_connect_callback(_In_ void *p_arg,
                                              _In_z_ const char *p_conn_ip,
                                              _In_ uint16_t p_conn_port,
                                              _In_z_ const char *p_local_ip,
                                              _In_ uint16_t p_local_port,
<span style = "background-color:#dfd">                                              _In_ rist_peer *p_peer) {</span>
  const auto _rist_nn =
<span style = "background-color:#dfd">      gsl::not_null&lt;w_rist *&gt;(gsl::narrow_cast&lt;w_rist *&gt;(p_arg));</span>

<span style = "background-color:#dfd">  if (_rist_nn-&gt;on_auth_connected_callback) {</span>
<span style = "background-color:#fdd">    _rist_nn-&gt;on_auth_connected_callback(p_conn_ip, p_conn_port, p_local_ip,</span>
                                         p_local_port);
  }

<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

static int s_on_auth_handler_disconnect_callback(_In_ void *p_arg,
<span style = "background-color:#dfd">                                                 _In_ rist_peer *p_peer) {</span>
  const auto _rist_nn =
<span style = "background-color:#dfd">      gsl::not_null&lt;w_rist *&gt;(gsl::narrow_cast&lt;w_rist *&gt;(p_arg));
  if (_rist_nn-&gt;on_auth_disconnected_callback) {</span>
<span style = "background-color:#fdd">    _rist_nn-&gt;on_auth_disconnected_callback();</span>
  }
<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

static int s_on_receiver_data_callback(_In_ void *p_arg,
<span style = "background-color:#dfd">                                       _In_ rist_data_block *p_data_block) {</span>
  const auto _rist_nn =
<span style = "background-color:#dfd">      gsl::not_null&lt;w_rist *&gt;(gsl::narrow_cast&lt;w_rist *&gt;(p_arg));
  const auto _data_block_nn = gsl::not_null&lt;rist_data_block *&gt;(p_data_block);</span>

<span style = "background-color:#dfd">  if (_rist_nn-&gt;on_receiver_data_callback) {
    auto _block = w_rist_data_block(std::move(*p_data_block));
    _rist_nn-&gt;on_receiver_data_callback(_block);
  } else {</span>
    // release block
<span style = "background-color:#fdd">    rist_receiver_data_block_free2(&amp;p_data_block);</span>
  }
<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

#pragma endregion

w_rist::w_rist(_In_ rist_ctx_mode p_mode, _In_ rist_profile p_profile,
               _In_ uint16_t p_loss_percentage,
               _In_ rist_log_level p_log_level) noexcept
<span style = "background-color:#dfd">    : _mode(p_mode), _profile(p_profile), _loss_percentage(p_loss_percentage),
      _log_level(p_log_level), _log(nullptr), _ctx(nullptr), _peer(nullptr) {}</span>
 
<span style = "background-color:#dfd"> w_rist::~w_rist() noexcept {
  if (this-&gt;_ctx != nullptr) {
    if (this-&gt;_peer != nullptr) {
      std::ignore = rist_peer_destroy(this-&gt;_ctx, this-&gt;_peer);
      this-&gt;_peer = nullptr;</span>
    }
<span style = "background-color:#dfd">    std::ignore = rist_destroy(this-&gt;_ctx);
    this-&gt;_ctx = nullptr;</span>
  }
<span style = "background-color:#dfd">  _release_log();
}</span>

<span style = "background-color:#dfd"> void w_rist::_release_log() {
  if (this-&gt;_log == nullptr)
    return;</span>

<span style = "background-color:#dfd">  rist_logging_unset_global();
  rist_logging_settings_free2(&amp;this-&gt;_log);
}</span>

<span style = "background-color:#dfd">boost::leaf::result&lt;int&gt; w_rist::init() {</span>

  // first release resources of context and log
<span style = "background-color:#dfd">  _release_log();
  if (this-&gt;_ctx != nullptr) {</span>
<span style = "background-color:#fdd">    std::ignore = rist_destroy(this-&gt;_ctx);</span>
  }

  // now create a log
  if (rist_logging_set(&amp;this-&gt;_log, this-&gt;_log_level, s_on_log_callback, this,
<span style = "background-color:#dfd">                       nullptr, stderr) != 0) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::operation_canceled,</span>
                 "could not create a rist log callback");
  }

  // create a rist context
<span style = "background-color:#dfd">  constexpr uint16_t _max_loss = 22;
  if (this-&gt;_mode == rist_ctx_mode::RIST_SENDER_MODE) {</span>

    // create a sender
<span style = "background-color:#dfd">    const auto _ret =</span>
        rist_sender_create(&amp;this-&gt;_ctx, this-&gt;_profile, 0, this-&gt;_log);
<span style = "background-color:#dfd">    if (_ret != 0) {</span>
<span style = "background-color:#fdd">      return W_ERR(std::errc::operation_canceled,</span>
                   "could not create a rist sender context");
    }

<span style = "background-color:#dfd">    if (this-&gt;_loss_percentage &gt; 0) {</span>
<span style = "background-color:#fdd">      this-&gt;_ctx-&gt;sender_ctx-&gt;simulate_loss = true;
      this-&gt;_ctx-&gt;sender_ctx-&gt;loss_percentage =</span>
          this-&gt;_loss_percentage &gt; _max_loss ? _max_loss
                                             : this-&gt;_loss_percentage;
    }
<span style = "background-color:#dfd">  } else {</span>
    // create a receiver
<span style = "background-color:#dfd">    const auto _ret =</span>
        rist_receiver_create(&amp;this-&gt;_ctx, this-&gt;_profile, this-&gt;_log);

<span style = "background-color:#dfd">    if (_ret != 0) {</span>
<span style = "background-color:#fdd">      return W_ERR(std::errc::operation_canceled,</span>
                   "could not create a rist receiver context");
    }

<span style = "background-color:#dfd">    if (this-&gt;_loss_percentage &gt; 0) {</span>
<span style = "background-color:#fdd">      this-&gt;_ctx-&gt;receiver_ctx-&gt;simulate_loss = true;
      this-&gt;_ctx-&gt;receiver_ctx-&gt;loss_percentage =</span>
          this-&gt;_loss_percentage &gt; _max_loss ? _max_loss
                                             : this-&gt;_loss_percentage;
    }

    if (rist_receiver_data_callback_set2(
<span style = "background-color:#dfd">            this-&gt;_ctx, s_on_receiver_data_callback, this) != 0) {</span>
<span style = "background-color:#fdd">      return W_ERR(std::errc::operation_canceled,</span>
                   "could not set data receiver callback");
    }
  }

  if (rist_auth_handler_set(this-&gt;_ctx, s_on_auth_handler_connect_callback,
<span style = "background-color:#dfd">                            s_on_auth_handler_disconnect_callback, this) != 0) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::operation_canceled,</span>
                 "could not set rist auth handler");
  }

<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

boost::leaf::result&lt;int&gt;
<span style = "background-color:#dfd">w_rist::connect(_In_ const std::string_view p_endpoint) {</span>

<span style = "background-color:#dfd">  if (p_endpoint.empty()) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::bad_address, "missing endpoint url");</span>
  }

<span style = "background-color:#dfd">  if (this-&gt;_peer != nullptr) {</span>
<span style = "background-color:#fdd">    std::ignore = rist_peer_destroy(this-&gt;_ctx, this-&gt;_peer);</span>
  }

  // rely on the library to parse the url
<span style = "background-color:#dfd">  auto *_peer_config =</span>
      gsl::owner&lt;rist_peer_config *&gt;(calloc(1, sizeof(rist_peer_config)));
  // check for memory violation
<span style = "background-color:#dfd">  std::ignore = gsl::not_null&lt;rist_peer_config *&gt;(_peer_config);</span>


<span style = "background-color:#dfd">  rist_peer_config_defaults_set(_peer_config);</span>
  //if (parse_url_options(url_local, _peer_config) != 0) {
  //  return W_ERR(std::errc::bad_address,
  //               "could not parse peer options for receiver");
  //}

<span style = "background-color:#dfd">  if (rist_parse_address2(p_endpoint.data(), &amp;_peer_config) != 0) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::bad_address,</span>
                 "could not parse peer options for receiver");
  }

<span style = "background-color:#dfd">  if (rist_peer_create(this-&gt;_ctx, &amp;this-&gt;_peer, _peer_config) != 0) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::operation_canceled,</span>
                 "could not add peer connector to receiver");
  }

<span style = "background-color:#dfd">  free(_peer_config);</span>

<span style = "background-color:#dfd">  if (rist_start(this-&gt;_ctx) != 0) {</span>
<span style = "background-color:#fdd">    return W_ERR(std::errc::operation_canceled,</span>
                 "could not add peer connector to receiver");
  }

<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

boost::leaf::result&lt;size_t&gt;
<span style = "background-color:#dfd">w_rist::send(_In_ const w_rist_data_block &amp;p_block) {
  auto _bytes = rist_sender_data_write(this-&gt;_ctx, p_block._block);
  return _bytes &gt;= 0</span>
             ? boost::leaf::result&lt;size_t&gt;(gsl::narrow_cast&lt;size_t&gt;(_bytes))
             : W_ERR(std::errc::no_message,
                     "could not send data block to the rist stream");
<span style = "background-color:#dfd">}</span>

boost::leaf::result&lt;size_t&gt; w_rist::receive(_Inout_ w_rist_data_block &amp;p_block,
<span style = "background-color:#dfd">                                            _In_ int p_timeout_ms) {
  const gsl::not_null&lt;rist_ctx *&gt; _ctx_nn(this-&gt;_ctx);
  auto _bytes =</span>
      rist_receiver_data_read2(_ctx_nn, &amp;p_block._block, p_timeout_ms);
<span style = "background-color:#dfd">  return _bytes &gt;= 0</span>
             ? boost::leaf::result&lt;size_t&gt;(gsl::narrow_cast&lt;size_t&gt;(_bytes))
             : W_ERR(std::errc::no_message,
                     "could not read data block from the rist stream");
<span style = "background-color:#fdd">  return W_SUCCESS;</span>
<span style = "background-color:#dfd">}</span>

#endif</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>