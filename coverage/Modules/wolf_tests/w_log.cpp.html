<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_log.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#ifdef WOLF_SYSTEM_LOG

#include "w_log.hpp"

using w_log = wolf::system::log::w_log;
using w_log_config = wolf::system::log::w_log_config;

<span style = "background-color:#dfd">w_log::w_log(const w_log_config &amp;p_config) noexcept : _config(p_config) {}</span>

<span style = "background-color:#dfd">w_log::~w_log() noexcept {</span>
  try {
<span style = "background-color:#dfd">    flush();</span>
<span style = "background-color:#fdd">  } catch (...) {
  }</span>
<span style = "background-color:#dfd">}</span>

<span style = "background-color:#dfd">boost::leaf::result&lt;int&gt; w_log::init() {</span>
  // first create a directory for log
<span style = "background-color:#dfd">  const auto _parent_path = this-&gt;_config.path.parent_path();
  const auto _is_dir = std::filesystem::is_directory(_parent_path);
  if (!_is_dir) {</span>
    // try to create a directory for it
<span style = "background-color:#fdd">    const auto _dir_created = std::filesystem::create_directory(_parent_path);
    if (!_dir_created) {
      return W_ERR(std::errc::invalid_argument,</span>
                   "could not create log directory path");
    }
  }

  // create sinks
<span style = "background-color:#dfd">  std::vector&lt;spdlog::sink_ptr&gt; _sinks;
  if (this-&gt;_config.type &amp; w_log_sink::CONSOLE) {
    if (this-&gt;_config.multi_threaded) {
      _sinks.push_back(std::make_shared&lt;spdlog::sinks::stdout_color_sink_mt&gt;());
    } else {</span>
<span style = "background-color:#fdd">      _sinks.push_back(std::make_shared&lt;spdlog::sinks::stdout_color_sink_st&gt;());</span>
    }
  }

#if defined(_MSC_VER)
<span style = "background-color:#dfd">  if (this-&gt;_config.type &amp; w_log_sink::VISUAL_STUDIO) {
    if (this-&gt;_config.multi_threaded) {
      _sinks.push_back(std::make_shared&lt;spdlog::sinks::msvc_sink_mt&gt;());
    } else {</span>
<span style = "background-color:#fdd">      _sinks.push_back(std::make_shared&lt;spdlog::sinks::msvc_sink_st&gt;());</span>
    }
  }
#endif

<span style = "background-color:#dfd">  const auto _level = this-&gt;_config.level;
  const auto _flush_level = this-&gt;_config.flush_level;</span>

<span style = "background-color:#dfd">  const auto _filename = this-&gt;_config.path.filename().string();
  const auto _path = this-&gt;_config.path.string();</span>

<span style = "background-color:#dfd">  if (this-&gt;_config.type &amp; w_log_sink::ASYNC_FILE) {</span>
    // async file sink
<span style = "background-color:#fdd">    this-&gt;_async_file_logger =</span>
        spdlog::create_async_nb&lt;spdlog::sinks::rotating_file_sink_mt&gt;(
            _filename, _path, this-&gt;_config.max_file_size_in_mb,
            this-&gt;_config.max_files, this-&gt;_config.rotate_on_open);
    // test for memory violation
<span style = "background-color:#fdd">    std::ignore = gsl::not_null&lt;spdlog::logger *&gt;(_async_file_logger.get());</span>

<span style = "background-color:#fdd">    this-&gt;_async_file_logger-&gt;set_level(_level);
    this-&gt;_async_file_logger-&gt;flush_on(_flush_level);</span>
<span style = "background-color:#dfd">  } else if (this-&gt;_config.type &amp; w_log_sink::ASYNC_DAILY_FILE) {</span>
    // async daily file sink
<span style = "background-color:#fdd">    this-&gt;_async_file_logger =</span>
        spdlog::create_async_nb&lt;spdlog::sinks::daily_file_sink_mt&gt;(
            _filename, _path, this-&gt;_config.hour, this-&gt;_config.minute,
            false, // truncate
            gsl::narrow_cast&lt;uint16_t&gt;(this-&gt;_config.max_files));
    // test for memory violation
<span style = "background-color:#fdd">    std::ignore = gsl::not_null&lt;spdlog::logger *&gt;(_async_file_logger.get());</span>

<span style = "background-color:#fdd">    this-&gt;_async_file_logger-&gt;set_level(_level);
    this-&gt;_async_file_logger-&gt;flush_on(_flush_level);</span>
  }

  // create logger for other sinks
<span style = "background-color:#dfd">  this-&gt;_logger =</span>
      std::make_shared&lt;spdlog::logger&gt;(_filename, _sinks.begin(), _sinks.end());
  // test for memory violation
<span style = "background-color:#dfd">  std::ignore = gsl::not_null&lt;spdlog::logger *&gt;(this-&gt;_logger.get());</span>

<span style = "background-color:#dfd">  this-&gt;_logger-&gt;set_level(_level);
  this-&gt;_logger-&gt;flush_on(_flush_level);</span>

<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

<span style = "background-color:#dfd">void w_log::write(_In_ const std::string_view &amp;p_fmt) {
  write(spdlog::level::level_enum::info, p_fmt);
}</span>

void w_log::write(_In_ const spdlog::level::level_enum &amp;p_level,
<span style = "background-color:#dfd">                  _In_ const std::string_view &amp;p_fmt) {
  if (this-&gt;_logger != nullptr) {
    this-&gt;_logger-&gt;log(p_level, p_fmt);</span>
  }
<span style = "background-color:#dfd">  if (this-&gt;_async_file_logger != nullptr) {</span>
<span style = "background-color:#fdd">    this-&gt;_async_file_logger-&gt;log(p_level, p_fmt);</span>
  }
<span style = "background-color:#dfd">}</span>

<span style = "background-color:#dfd">boost::leaf::result&lt;int&gt; w_log::flush() {
  if (this-&gt;_logger.get() != nullptr) {
    this-&gt;_logger-&gt;flush();</span>
  }
<span style = "background-color:#dfd">  if (this-&gt;_async_file_logger.get() != nullptr) {</span>
<span style = "background-color:#fdd">    this-&gt;_async_file_logger-&gt;flush();</span>
  }

<span style = "background-color:#dfd">  return W_SUCCESS;
}</span>

<span style = "background-color:#fdd">w_log_config w_log::get_config() const { return this-&gt;_config; }</span>

#endif</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>