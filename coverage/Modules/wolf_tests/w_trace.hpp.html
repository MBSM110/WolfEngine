<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>w_trace.hpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
/*
    Project: Wolf Engine. Copyright Â© 2014-2022 Pooya Eimandar
    https://github.com/WolfEngine/WolfEngine
*/

#pragma once

#include &lt;boost/leaf.hpp&gt;
#include &lt;deque&gt;
#include &lt;ostream&gt;
#include &lt;string&gt;
#include &lt;thread&gt;

struct w_trace {
  struct stack {
    friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;p_os,
<span style = "background-color:#dfd">                                    stack const &amp;p_trace) noexcept {</span>
      try {
<span style = "background-color:#dfd">        p_os &lt;&lt; "|tid:" &lt;&lt; p_trace.thread_id &lt;&lt; "|code:" &lt;&lt; p_trace.err_code</span>
             &lt;&lt; "|msg:" &lt;&lt; p_trace.err_msg &lt;&lt; "|src:" &lt;&lt; p_trace.source_file
             &lt;&lt; "(" &lt;&lt; p_trace.source_file_line &lt;&lt; ")" &lt;&lt; std::endl;
<span style = "background-color:#fdd">      } catch (...) {
      }</span>
<span style = "background-color:#dfd">      return p_os;
    }</span>
    std::thread::id thread_id;
    int64_t err_code = 0;
    std::string err_msg;
    std::string source_file;
    uint32_t source_file_line = 0;
  } W_ALIGNMENT_128;

  w_trace() noexcept = default;

  w_trace(_In_ stack &amp;&amp;p_stack) noexcept {
    try {
      this-&gt;_stacks.emplace_front(p_stack);
    } catch (...) {
    }
  }

<span style = "background-color:#fdd">  w_trace(_In_ int64_t p_err_code, _In_ std::string p_err_msg,</span>
          _In_ const char *p_source_file,
          _In_ uint32_t p_source_file_line) noexcept {
    try {
<span style = "background-color:#fdd">      this-&gt;_stacks.emplace_front(stack{std::this_thread::get_id(), p_err_code,</span>
                                        std::move(p_err_msg), p_source_file,
                                        p_source_file_line});
<span style = "background-color:#fdd">    } catch (...) {
    }
  }</span>

<span style = "background-color:#dfd">  w_trace(_In_ std::errc p_err_code, _In_ std::string p_err_msg,</span>
          _In_ const char *p_source_file,
          _In_ uint32_t p_source_file_line) noexcept {
    try {
<span style = "background-color:#dfd">      this-&gt;_stacks.emplace_front(stack{</span>
          std::this_thread::get_id(), gsl::narrow_cast&lt;int64_t&gt;(p_err_code),
          std::move(p_err_msg), p_source_file, p_source_file_line});
<span style = "background-color:#fdd">    } catch (...) {
    }</span>
<span style = "background-color:#dfd">  }</span>

  void push(_In_ int64_t p_err_code, _In_ std::string p_err_msg,
            _In_ const char *p_source_file,
            _In_ uint32_t p_source_file_line) noexcept {
    try {
      this-&gt;_stacks.emplace_front(stack{std::this_thread::get_id(), p_err_code,
                                        std::move(p_err_msg), p_source_file,
                                        p_source_file_line});
    } catch (...) {
    }
  }

  friend std::ostream &amp;operator&lt;&lt;(std::ostream &amp;p_os,
<span style = "background-color:#dfd">                                  w_trace const &amp;p_trace) noexcept {</span>
    try {
<span style = "background-color:#dfd">      for (const auto &amp;index : p_trace._stacks) {
        p_os &lt;&lt; index;
      }</span>
<span style = "background-color:#fdd">    } catch (...) {
    }</span>
<span style = "background-color:#dfd">    return p_os;
  }</span>

private:
<span style = "background-color:#dfd">  std::deque&lt;stack&gt; _stacks = {};</span>
};

constexpr inline int W_SUCCESS = 0;

template&lt;typename T&gt;
#ifndef __clang__
requires std::movable&lt;T&gt;
#endif
<span style = "background-color:#dfd">constexpr inline boost::leaf::result&lt;T&gt; W_OK(T &amp;p_param) noexcept {
    return boost::leaf::result&lt;T&gt;(std::move(p_param));
}</span>

inline boost::leaf::result&lt;int&gt; W_OK() noexcept { return {W_SUCCESS}; }

#define W_ERR(p_code, p_msg) boost::leaf::new_error(w_trace(p_code, p_msg, __FILE__, __LINE__))

#ifdef WIN32

<span style = "background-color:#fdd">inline std::string get_last_win_error(_In_ DWORD p_error_id) {
    if (p_error_id == 0) {
        return {};</span>
    }

<span style = "background-color:#fdd">    LPSTR _msg_buffer = nullptr;</span>

    // Ask Win32 to give us the string version of that message ID.
    // The parameters we pass in, tell Win32 to create the buffer that holds the
    // message for us (because we don't yet know how long the message string
    // will be).
<span style = "background-color:#fdd">    const auto _size = FormatMessageA(</span>
        FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM |
            FORMAT_MESSAGE_IGNORE_INSERTS,
        nullptr, p_error_id, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
        (LPSTR)&amp;_msg_buffer, 0, NULL);

    // Copy the error message into a std::string.
<span style = "background-color:#fdd">    std::string _message(_msg_buffer, _size);</span>

    // Free the Win32's string's buffer.
<span style = "background-color:#fdd">    LocalFree(_msg_buffer);</span>

<span style = "background-color:#fdd">    return _message;
}</span>

#endif</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>